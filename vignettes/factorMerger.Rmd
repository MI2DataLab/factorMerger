---
title: "factorMerger: set of tools to support results from post hoc testing"
author: "Agnieszka Sitko"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", warning = FALSE, message = FALSE,
                      fig.height = 5, fig.width = 7)
```

## Introduction

The aim of `factorMerger` is to provide set of tools to support results from post hoc comparisons. Post hoc testing is an analysis performed after running *ANOVA* to examine differences between group means (of some response numeric variable) for each pair of groups (groups are defined by a factor variable).

This project arose from the need to create a method of post hoc testing which gives the hierarchical interpretation of relations between groups means. Thereby, for a given significance level we may divide groups into nonoverlapping cluster. 

## Algorithm inputs

Current version of `factorMerger` accepts **one-dimensional grouping variable** as independent variable only (multi-dimensional version is yet to be written; grouping variable is discrete). When it comes to dependent variable, `factorMerger` supports the following models:

 - **gaussian** - either with one-dimensional or multivariate response,
 - **binomial**,
 - **survival**.
 
In each case we may specify whether in a single iteration of the algorithm test statistics are calculated for every possible pair of factor levels (cubic complexity) or only for "subsequent" pairs (quadratic complexity).

If the latter option is chosen factor variable is reordered before merging is performed. Order is determined on the basis of:

 - groups means of the response variable for *one-dimensional gaussian model*,
 - groups means of the vector fitted by non-metric multidimensional scaling for *multivariate gaussian model*,
 - groups proportions of the response variable for *binomial model*,
 - ... for *survival model*.

## Generating samples 

To visualize functionalities of `factorMerger` we use samples for which response variable is generated from one of the distributions listed above and corresponding factor variable is sampled uniformly from a finite set of a size $k$. 

To do so, we may use function `generateSample` or `generateMultivariateSample`.

```{r}
library(factorMerger) 
randSample <- generateMultivariateSample(N = 1000, k = 10, d = 3)
```

## Merging factors

`mergeFactors` is a function that performs hierarchical post hoc testing. As arguments it takes:

 - matrix/data.frame/vector with numeric response,
 - factor vector defining groups.

### Gaussian multi-dimensional response

#### Calculations



```{r}
fm <- mergeFactors(randSample$response, randSample$factor)
```

`mergeFactors` outputs with information about 'merging history'.

```{r}
print(fm)
```

Each row of the above frame describes one step of the merging algorithm. First two columns specify which groups were merged in the iteration, column 'model' gathers some statistic calculated for the model after merging (e.g. in gaussian case loglikelihood is calculated), column 'pval' gives significance threshold below which hypothesis about means equality holds.

If we set `subsequent = TRUE` then at the beginning one dimensional response is fitted using `isoMDS{MASS}`. Then, in each step only groups whose means are closed are compared.

```{r}
fm <- mergeFactors(randSample$response, randSample$factor, subsequent = TRUE)
print(fm)
```



#### Visualizations

We may plot results using functions `plotTree`. `plotTree` enables to specify what should be displayed on x axis (either column 'model' or logarithm of 'pval').

```{r, fig.height = 5, fig.width = 7}
plotTree(fm, stat = "model")
```

```{r, fig.height = 5, fig.width = 7}
plotTree(fm, "pval")
```

It also takes logical argument `simplify`, which controls how x axis is displayed. If `simplify = FALSE` then each node is connected the mean/mean of isoMDS projection/proportion of observations respresented by the node. Otherwise nodes are plotted using equal intervals on the x axis. As default we use `simplify = TRUE`. 

```{r}
plotTree(fm, simplify = FALSE)
```



We may also want to visualize dependent variables together with created tree. `factorMergers` introduces two functions for this purpose:

 - `plotProfile` (resulting in rank plot),
 - `plotHeatmap`.
 
```{r, fig.height = 5, fig.width = 7}
appendToTree(fm, plotProfile(fm))
```

In the above plots colours are connected with the group. The plot on the right shows means rankings for all variables included in the algorithm. 

```{r, fig.height = 5, fig.width = 7}
appendToTree(fm, plotHeatmap(fm))
```

The heatmap on the right shows means of all variables taken into analysis by groups.

### One-dimensional gaussian response

```{r}
oneDimRandSample <- generateSample(1000, 5)
```
```{r}
oneDimFm <- mergeFactors(oneDimRandSample$response, oneDimRandSample$factor)
plotTree(oneDimFm, simplify = FALSE)
```

```{r}
appendToTree(oneDimFm, plotBoxplot(oneDimFm))
```


### Binomial response

```{r}
binomRandSample <- generateSample(1000, 10, distr = "binomial")
table(binomRandSample$response, binomRandSample$factor)
```

```{r}
binomFm <- mergeFactors(binomRandSample$response, binomRandSample$factor, family = "binomial", subsequent = TRUE)
print(binomFm)
```

```{r}
plotTree(binomFm)
```

```{r}
plotTree(binomFm, simplify = FALSE)
```

```{r}
appendToTree(binomFm, plotProportion(binomFm))
```


### Survival model
 
 
```{r}
library(survival)
data(veteran)
survivalFm <- mergeFactors(response = subset(veteran, select = c(time, status)), 
                   factor = veteran$celltype, 
                   family = "survival")
```

```{r}
survivalFm <- mergeFactors(response = subset(veteran, select = c(time, status)), 
                   factor = veteran$celltype, 
                   subsequent = TRUE,
                   family = "survival")

```


```{r}
plotTree(survivalFm, "model")
```

```{r}
plotTree(survivalFm, "pval", simplify = FALSE)
```

```{r}
appendToTree(survivalFm, plotSurvival(survivalFm))
```

